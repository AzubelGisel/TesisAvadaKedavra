<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pago - Avada Kedavra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/estilo.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="aparicion-hogwarts">

  <div class="container">
    <div class="carrito-marco">
      <h2 class="mb-4">üí∞ M√©todo de Pago</h2>

      <form id="formPago">
        <div class="mb-3">
          <label for="metodo" class="form-label">Seleccion√° un m√©todo</label>
          <select class="form-select" id="metodo" required>
            <option value="">-- Eleg√≠ una opci√≥n --</option>
            <option value="tarjeta">Tarjeta de cr√©dito</option>
            <option value="mercadopago">MercadoPago</option>
            <option value="transferencia">Transferencia bancaria</option>
            <option value="qr">Pago QR</option>
          </select>
        </div>

        <div id="formularioEspecifico"></div>

        <div class="mb-3 mt-4">
          <label class="form-label">Tipo de entrega</label>
          <div>
            <input type="radio" name="envio" value="domicilio" id="envioDomicilio" required>
            <label for="envioDomicilio">Env√≠o a domicilio (+$15.000)</label>
          </div>
          <div>
            <input type="radio" name="envio" value="sucursal" id="envioSucursal">
            <label for="envioSucursal" style="color: #007bff;">Retiro en sucursal (Gratis)</label>
          </div>
        </div>

        <!-- Checkbox visual para activar o desactivar el modo debug -->
        <div class="form-check mb-4">
           <input class="form-check-input" type="checkbox" id="modoDebugToggle" checked>
            <!-- El checkbox est√° marcado por defecto (modo debug activado) -->
            <label class="form-check-label" for="modoDebugToggle">
             Activar modo debug (no abrir WhatsApp)
          </label>
        </div>


        <div class="text-end mt-4">
          <button id="confirmarPago" class="btn btn-success">Finalizar Compra</button>
        </div>
      </form>

      <div id="resumenCompra" class="mt-5" style="display:none;">
        <h4>üßæ Resumen de la compra</h4>
        <p id="detalleProductos"></p>
        <p id="detalleEnvio"></p>
        <p id="totalFinal" class="fw-bold"></p>
        <hr>
        <h5>üìç Datos del comprador</h5>
        <p id="datosComprador"></p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.addEventListener("load", () => {
      const metodo = document.getElementById("metodo");
      const formularioEspecifico = document.getElementById("formularioEspecifico");
      const btn = document.getElementById("confirmarPago");
      const resumen = document.getElementById("resumenCompra");
      const detalleProductos = document.getElementById("detalleProductos");
      const detalleEnvio = document.getElementById("detalleEnvio");
      const totalFinal = document.getElementById("totalFinal");
      const datosComprador = document.getElementById("datosComprador");

      metodo.addEventListener("change", () => {
        const tipo = metodo.value;
        formularioEspecifico.innerHTML = "";

        if (tipo === "tarjeta") {
          formularioEspecifico.innerHTML = `
            <div class="mb-3">
              <label for="tarjeta" class="form-label">N√∫mero de tarjeta</label>
              <input type="text" class="form-control" id="tarjeta" required>
            </div>
            <div class="mb-3">
              <label for="nombreTarjeta" class="form-label">Nombre en la tarjeta</label>
              <input type="text" class="form-control" id="nombreTarjeta" required>
            </div>
            <div class="mb-3">
              <label for="vencimiento" class="form-label">Vencimiento</label>
              <input type="month" class="form-control" id="vencimiento" required>
            </div>
            <div class="mb-3">
              <label for="cvv" class="form-label">CVV</label>
              <input type="text" class="form-control" id="cvv" required>
            </div>
          `;
        } else if (tipo === "mercadopago") {
          formularioEspecifico.innerHTML = `
            <div class="mb-3">
              <label for="emailMP" class="form-label">Email de MercadoPago</label>
              <input type="email" class="form-control" id="emailMP" required>
            </div>
          `;
        } else if (tipo === "transferencia") {
          formularioEspecifico.innerHTML = `
            <div class="mb-3">
              <label for="cbu" class="form-label">CBU/CVU</label>
              <input type="text" class="form-control" id="cbu" required>
            </div>
            <div class="mb-3">
              <label for="titular" class="form-label">Titular de la cuenta</label>
              <input type="text" class="form-control" id="titular" required>
            </div>
          `;
        } else if (tipo === "qr") {
          formularioEspecifico.innerHTML = `
            <div class="mb-3">
              <label for="aliasQR" class="form-label">Alias o ID QR</label>
              <input type="text" class="form-control" id="aliasQR" required>
            </div>
          `;
        }
      });

      btn.addEventListener("click", (e) => {
        e.preventDefault();

        const tipo = metodo.value;
        if (!tipo) {
          metodo.classList.add("is-invalid");
          return;
        } else {
          metodo.classList.remove("is-invalid");
        }

        let valido = true;
        const campos = formularioEspecifico.querySelectorAll("input");
        campos.forEach(campo => {
          if (!campo.value.trim()) {
            campo.classList.add("is-invalid");
            valido = false;
          } else {
            campo.classList.remove("is-invalid");
          }
        });

        if (!valido) return;

        if (tipo === "tarjeta") {
          const numero = document.getElementById("tarjeta").value.replace(/\s/g, "");
          const regex = /^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14})$/;
          if (!regex.test(numero)) {
            alert("Tarjeta inv√°lida o no reconocida.");
            return;
          }
        }

        const envioElegido = document.querySelector('input[name="envio"]:checked');
        if (!envioElegido) {
          alert("Seleccion√° un tipo de entrega.");
          return;
        }

        const productos = JSON.parse(localStorage.getItem("carrito")) || [
          { nombre: "T√∫nica de Gryffindor", precio: 4999 },
          { nombre: "Bufanda de Slytherin", precio: 2999 }
        ];

        let total = productos.reduce((acc, p) => acc + parseFloat(p.precio), 0);

        let envioTexto = "";
        if (envioElegido.value === "domicilio") {
          total += 15000;
          envioTexto = "Env√≠o a domicilio (+$15.000)";
        } else {
          envioTexto = "Retiro en sucursal (Gratis)";
        }

        detalleProductos.innerHTML = productos.map(p => `ü™Ñ ${p.nombre} - $${p.precio}`).join("<br>");
                detalleEnvio.innerHTML = `üöö ${envioTexto}`;
        totalFinal.innerHTML = `üí∏ Total: $${total}`;

        const datos = ["nombre", "direccion", "ciudad", "codigoPostal", "email", "telefono"].map(id => {
          const valor = localStorage.getItem("envio_" + id);
          return valor ? `<strong>${id}:</strong> ${valor}` : "";
        }).join("<br>");
        datosComprador.innerHTML = datos;

        resumen.style.display = "block";

        // Recupera el n√∫mero de tel√©fono guardado en localStorage
const telefono = localStorage.getItem("envio_telefono");

// Lee el estado actual del checkbox visual en el momento del clic
const modoDebug = document.getElementById("modoDebugToggle").checked;

if (telefono) {
  // Genera el mensaje de WhatsApp con todos los datos del pedido
  const mensaje = encodeURIComponent(
    `üßæ Gracias por tu compra en Avada Kedavra.\n` +
    `Total: $${total}\n` +
    `${envioTexto}\n` +
    `Productos:\n` +
    productos.map(p => `- ${p.nombre}: $${p.precio}`).join("\n") + `\n` +
    `üìç Env√≠o a: ${localStorage.getItem("envio_direccion")}, ${localStorage.getItem("envio_ciudad")}\n` +
    `üìû Contacto: ${telefono}`
  );

  // Construye el link de WhatsApp con el mensaje generado
  const link = `https://wa.me/${telefono.replace(/\D/g, "")}?text=${mensaje}`;

  if (modoDebug) {
    // Si el checkbox est√° marcado, se activa el modo debug
    console.log("üß™ Modo debug activado");
    console.log("Mensaje generado:", decodeURIComponent(mensaje));
    console.log("Link simulado:", link);
    alert("Modo debug: el mensaje fue generado pero no se envi√≥.");
  } else {
    // Si el checkbox est√° desmarcado, se abre WhatsApp con el mensaje real
    setTimeout(() => {
      window.open(link, "_blank");
    }, 1000);
  }
}

// Guarda el tipo de env√≠o elegido para mostrarlo en confirmacion.html
localStorage.setItem("envio_tipo", envioTexto);


// Guarda el total final calculado para mostrarlo en confirmacion.html
localStorage.setItem("envio_total", total.toFixed(2));


// Guarda el estado del modo debug (true o false) para que confirmacion.html lo respete
localStorage.setItem("modo_debug", modoDebug);

// Guarda el carrito para mostrar los productos en confirmacion.html
localStorage.setItem("carrito", JSON.stringify(productos));

// Redirige autom√°ticamente a la vista de confirmaci√≥n
window.location.href = "confirmacion.html";


      });
    });
  </script>
</body>
</html>
